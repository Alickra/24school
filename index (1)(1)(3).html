<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æŠ½ç­¾ç³»ç»Ÿ</title>
    <style>
        /* æ–°å¢è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 20px;
            background: #ff4757;
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
            z-index: 1000;
        }

        .settings-btn:hover {
            background: #ff6b81;
            transform: scale(1.05);
        }

        .slot.wide-column {
            width: 300px; 
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            margin: 0;
            color: white;
            font-family: Arial;
            position: relative; /* ä¸ºå›ºå®šå®šä½æŒ‰é’®æä¾›å‚è€ƒ */
        }

        .slots-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .slot {
            width: 150px;
            height: 50px;
            overflow: hidden;
            border-radius: 10px;
            background: #2c2c2c;
            position: relative;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }

        .slot::before,
        .slot::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 30%;
            z-index: 2;
            pointer-events: none;
        }

        .slot::before {
            top: 0;
            background: linear-gradient(to bottom, #1a1a1a 0%, transparent 100%);
        }

        .slot::after {
            bottom: 0;
            background: linear-gradient(to top, #1a1a1a 0%, transparent 100%);
        }

        .slot-content {
            position: absolute;
            width: 100%;
        }

        .slot-item {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            padding: 0 8px;
            text-align: center;
            line-height: 1.2;
        }

        .spin-button {
            padding: 12px 35px;
            background: #ff4757;
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }

        .spin-button:hover {
            background: #ff6b81;
            transform: scale(1.05);
        }

        #result {
            margin-top: 20px;
            text-align: center;
            min-height: 60px;
            font-size: 18px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        /* è®¾ç½®é¢æ¿æ ·å¼ */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: #2c2c2c;
            border-radius: 15px;
            padding: 25px;
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .settings-header h2 {
            margin: 0;
            color: #ff4757;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-top: 0;
            color: #ddd;
        }

        .settings-section textarea {
            width: 100%;
            height: 120px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
        }

        .settings-section p {
            color: #aaa;
            font-size: 14px;
            margin-top: 5px;
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .save-btn {
            padding: 10px 25px;
            background: #ff4757;
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
        }

        .save-btn:hover {
            background: #ff6b81;
        }

        .reset-btn {
            padding: 10px 25px;
            background: #555;
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
            margin-right: 10px;
        }

        .reset-btn:hover {
            background: #777;
        }

        /* æ·»åŠ æƒé‡è®¾ç½®æ ·å¼ */
        .weight-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            color: white;
        }

        .weight-table th, .weight-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .weight-table th {
            color: #ddd;
            font-weight: normal;
        }

        .weight-input {
            width: 60px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            padding: 5px;
            text-align: center;
        }

        .tab-container {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            color: #aaa;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            margin-right: 10px;
        }

        .tab.active {
            color: #ff4757;
            border-bottom: 2px solid #ff4757;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ·»åŠ å†å²è®°å½•å’Œç»Ÿè®¡åˆ†ææ ·å¼ */
        .stats-container {
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            width: 80%;
            max-width: 500px;
            display: none;
        }

        .stats-title {
            color: #ff4757;
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }

        .stats-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .stats-item {
            background: #2c2c2c;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .toggle-stats {
            background: none;
            border: none;
            color: #aaa;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .toggle-stats:hover {
            color: white;
        }

        /* æ·»åŠ å¤§æ ‡é¢˜æ ·å¼ */
        .main-title {
            font-size: 36px;
            font-weight: bold;
            color: #ff4757;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
            animation: titleGlow 2s infinite alternate;
        }

        @keyframes titleGlow {
            from {
                text-shadow: 0 0 5px rgba(255, 71, 87, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
            }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #2c2c2c;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 5px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* è®¾ç½®é¢æ¿æ»šåŠ¨æ¡ç‰¹æ®Šæ ·å¼ */
        .settings-content::-webkit-scrollbar {
            width: 8px;
        }

        .settings-content::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
            margin: 5px;
        }

        .settings-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .settings-content::-webkit-scrollbar-thumb:hover {
            background: #ff4757;
        }

        /* ç§‘ç›®æŒ‰é’®æ ·å¼ */
        .subject-btn {
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.3s;
        }

        .subject-btn:hover {
            background: #444;
        }

        .subject-btn.active {
            background: #ff4757;
            border-color: #ff4757;
        }

        .subject-btn .delete-icon {
            margin-left: 8px;
            opacity: 0.6;
            transition: 0.3s;
        }

        .subject-btn:hover .delete-icon {
            opacity: 1;
        }
    </style>
</head>
<body>
    <button class="settings-btn" id="settingsBtn">è®¾ç½®</button>
    <h1 class="main-title">äºŒåå››ä¸­å­¦è‡³å°ŠæŠ½ç­¾</h1>
    <div id="currentSubjectDisplay" style="margin-bottom: 20px; color: #ff4757; font-size: 18px; font-weight: bold;"></div>
    <button class="spin-button" id="spinBtn">å¼€å§‹æŠ½ç­¾</button>
    <div class="slots-container">
        <div class="slot">
            <div class="slot-content" id="slot1"></div>
        </div>
        <div class="slot">
            <div class="slot-content" id="slot2"></div>
        </div>
        <div class="slot wide-column">
            <div class="slot-content" id="slot3"></div>
        </div>
    </div>
    <div id="result"></div>

    <!-- ç»Ÿè®¡åˆ†æå®¹å™¨ -->
    <div class="stats-container" id="statsContainer">
        <h3 class="stats-title">æŠ½ç­¾ç»Ÿè®¡</h3>
        <div class="stats-content" id="statsContent"></div>
    </div>
    <button class="toggle-stats" id="toggleStats">æ˜¾ç¤º/éšè—ç»Ÿè®¡</button>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>æŠ½ç­¾è®¾ç½®</h2>
                <button class="close-btn" id="closeSettings">Ã—</button>
            </div>
            <div class="settings-section">
                <h3>ç§‘ç›®ç®¡ç†</h3>
                <p>ä¿å­˜å½“å‰é…ç½®ä¸ºç§‘ç›®ï¼Œæˆ–åˆ‡æ¢åˆ°å·²ä¿å­˜çš„ç§‘ç›®é…ç½®</p>
                <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                    <input type="text" id="subjectName" placeholder="è¾“å…¥ç§‘ç›®åç§°" style="flex: 1; background: #3a3a3a; border: 1px solid #555; border-radius: 5px; color: white; padding: 8px; font-size: 15px;">
                    <button id="saveSubject" style="background: #ff4757; border: none; border-radius: 5px; color: white; padding: 8px 15px; cursor: pointer;">ä¿å­˜ç§‘ç›®</button>
                </div>
                <div style="margin-top: 15px;">
                    <h4 style="color: #ddd; margin-bottom: 10px;">å·²ä¿å­˜ç§‘ç›®</h4>
                    <div id="subjectsList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>
            </div>
            <div class="settings-section">
                <h3>å­¦ç”Ÿåå•</h3>
                <textarea id="studentsInput"></textarea>
                <p>æ¯ä¸ªåå­—ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”</p>
            </div>
            <div class="settings-section">
                <h3>ç¯‡ç›®åˆ—è¡¨</h3>
                <div class="tab-container">
                    <button class="tab active" data-tab="textsBasic">åŸºæœ¬è®¾ç½®</button>
                    <button class="tab" data-tab="textsAdvanced">é«˜çº§è®¾ç½® (æ¦‚ç‡)</button>
                </div>
                <div class="tab-content active" id="textsBasic">
                    <textarea id="textsInput"></textarea>
                    <p>æ¯ä¸ªç¯‡ç›®ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šèœ€é“éš¾,èœ€ç›¸,æœ›æµ·æ½®</p>
                </div>
                <div class="tab-content" id="textsAdvanced">
                    <p>è°ƒæ•´æ¯ä¸ªç¯‡ç›®è¢«æŠ½ä¸­çš„æ¦‚ç‡æƒé‡ï¼ˆæ•°å€¼è¶Šå¤§ï¼Œè¢«æŠ½ä¸­çš„æ¦‚ç‡è¶Šé«˜ï¼‰</p>
                    <table class="weight-table" id="textsWeightTable">
                        <thead>
                            <tr>
                                <th>ç¯‡ç›®</th>
                                <th>æƒé‡</th>
                                <th>æ¦‚ç‡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="settings-section">
                <h3>æƒ©ç½šå†…å®¹</h3>
                <div class="tab-container">
                    <button class="tab active" data-tab="punishmentsBasic">åŸºæœ¬è®¾ç½®</button>
                    <button class="tab" data-tab="punishmentsAdvanced">é«˜çº§è®¾ç½® (æ¦‚ç‡)</button>
                </div>
                <div class="tab-content active" id="punishmentsBasic">
                    <textarea id="punishmentsInput"></textarea>
                    <p>æ¯ä¸ªæƒ©ç½šç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šæ¼”å”±ç»¿è‰²,æ¼”å”±è·å¡˜æœˆè‰²,è®²ä¸€æ®µæ•…äº‹</p>
                </div>
                <div class="tab-content" id="punishmentsAdvanced">
                    <p>è°ƒæ•´æ¯ä¸ªæƒ©ç½šè¢«æŠ½ä¸­çš„æ¦‚ç‡æƒé‡ï¼ˆæ•°å€¼è¶Šå¤§ï¼Œè¢«æŠ½ä¸­çš„æ¦‚ç‡è¶Šé«˜ï¼‰</p>
                    <table class="weight-table" id="punishmentsWeightTable">
                        <thead>
                            <tr>
                                <th>æƒ©ç½š</th>
                                <th>æƒé‡</th>
                                <th>æ¦‚ç‡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="settings-section">
                <h3>æŠ½ç­¾æ—¶é•¿è®¾ç½® (æ¯«ç§’)</h3>
                <div style="display: flex; gap: 20px; margin-top: 15px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 8px;">å­¦ç”ŸæŠ½ç­¾æ—¶é•¿:</div>
                        <input type="number" id="duration1" min="1000" max="30000" step="1000" style="width: 100%; background: #3a3a3a; border: 1px solid #555; border-radius: 5px; color: white; padding: 8px; font-size: 15px;">
                    </div>
                    <div style="flex: 1;">
                        <div style="margin-bottom: 8px;">ç¯‡ç›®æŠ½ç­¾æ—¶é•¿:</div>
                        <input type="number" id="duration2" min="1000" max="30000" step="1000" style="width: 100%; background: #3a3a3a; border: 1px solid #555; border-radius: 5px; color: white; padding: 8px; font-size: 15px;">
                    </div>
                    <div style="flex: 1;">
                        <div style="margin-bottom: 8px;">æƒ©ç½šæŠ½ç­¾æ—¶é•¿:</div>
                        <input type="number" id="duration3" min="1000" max="30000" step="1000" style="width: 100%; background: #3a3a3a; border: 1px solid #555; border-radius: 5px; color: white; padding: 8px; font-size: 15px;">
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h3>å…¬å¹³æ€§è®¾ç½®</h3>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="checkbox" id="enableTrueRandom" style="margin-right: 10px; width: 16px; height: 16px;">
                    <label for="enableTrueRandom">ä½¿ç”¨æ›´å…¬å¹³çš„éšæœºç®—æ³•ï¼ˆæ¨èï¼‰</label>
                </div>
                <p>å¯ç”¨æ­¤é€‰é¡¹å¯ä»¥ç¡®ä¿æ¯ä¸ªé€‰é¡¹è¢«æŠ½ä¸­çš„æ¦‚ç‡å®Œå…¨ç›¸ç­‰</p>
            </div>
            <div class="settings-footer">
                <button class="reset-btn" id="resetSettings">æ¢å¤é»˜è®¤</button>
                <button class="save-btn" id="saveSettings">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤æ•°æ®
        const DEFAULT_STUDENTS = ["å¼ ä¸€","å¼ äºŒ","å¼ ä¸‰","å¼ å››","å¼ äº”","å¼ å…­","å¼ ä¸ƒ","å¼ å…«","å¼ ä¹","å¼ å","å¼ åä¸€","å¼ åäºŒ","å¼ åä¸‰","å¼ åå››","å¼ åäº”","å¼ åå…­","å¼ åä¸ƒ","å¼ åå…«","å¼ åä¹","å¼ äºŒå","å¼ äºŒåä¸€","å¼ äºŒåäºŒ","å¼ äºŒåä¸‰","å¼ äºŒåå››","å¼ äºŒåäº”","å¼ äºŒåå…­","å¼ äºŒåä¸ƒ","å¼ äºŒåå…«","å¼ äºŒåä¹","å¼ ä¸‰å","å¼ ä¸‰åä¸€","å¼ ä¸‰åäºŒ","å¼ ä¸‰åä¸‰","å¼ ä¸‰åå››","å¼ ä¸‰åäº”","å¼ ä¸‰åå…­","å¼ ä¸‰åä¸ƒ","å¼ ä¸‰åå…«","å¼ ä¸‰åä¹","å¼ å››å","å¼ å››åä¸€","å¼ å››åäºŒ","å¼ å››åä¸‰","å¼ å››åå››","å¼ å››åäº”","å¼ å››åå…­","å¼ å››åä¸ƒ"];
        const DEFAULT_TEXTS = ["èœ€é“éš¾", "èœ€ç›¸", "æœ›æµ·æ½®", "æ‰¬å·æ…¢", "å…¨éƒ¨"];
        const DEFAULT_PUNISHMENTS = ["æ¼”å”±ç»¿è‰²", "æ¼”å”±è·å¡˜æœˆè‰²", "è®²ä¸€æ®µå…«å¦/æ•…äº‹", "ç«™åˆ°èƒŒä¼š", "æŠ„å†™1é"];
        const DEFAULT_DURATIONS = [18000, 20000, 22000];

        // å½“å‰ä½¿ç”¨çš„æ•°æ®
        let students = [...DEFAULT_STUDENTS];
        let texts = [...DEFAULT_TEXTS];
        let punishments = [...DEFAULT_PUNISHMENTS];
        let durations = [...DEFAULT_DURATIONS];
        let enableTrueRandom = true; // é»˜è®¤å¯ç”¨çœŸéšæœº

        // æƒé‡æ•°æ®
        let textsWeights = {};
        let punishmentsWeights = {};

        const ITEM_HEIGHT = 50;
        const VISIBLE_ITEMS = 1; 
        let isRunning = false;

        // ç»Ÿè®¡æ•°æ®
        let statistics = {
            students: {},
            texts: {},
            punishments: {}
        };

        // DOMå…ƒç´ 
        const slot1 = document.getElementById('slot1');
        const slot2 = document.getElementById('slot2');
        const slot3 = document.getElementById('slot3');
        const result = document.getElementById('result');
        const spinBtn = document.getElementById('spinBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettings = document.getElementById('saveSettings');
        const resetSettings = document.getElementById('resetSettings');
        const studentsInput = document.getElementById('studentsInput');
        const textsInput = document.getElementById('textsInput');
        const punishmentsInput = document.getElementById('punishmentsInput');
        const duration1 = document.getElementById('duration1');
        const duration2 = document.getElementById('duration2');
        const duration3 = document.getElementById('duration3');
        const enableTrueRandomCheckbox = document.getElementById('enableTrueRandom');
        const statsContainer = document.getElementById('statsContainer');
        const statsContent = document.getElementById('statsContent');
        const toggleStats = document.getElementById('toggleStats');
        const subjectNameInput = document.getElementById('subjectName');
        const saveSubjectBtn = document.getElementById('saveSubject');
        const subjectsList = document.getElementById('subjectsList');
        const currentSubjectDisplay = document.getElementById('currentSubjectDisplay');

        // å½“å‰é€‰ä¸­çš„ç§‘ç›®
        let currentSubject = null;

        // æ›´æ–°å½“å‰ç§‘ç›®æ˜¾ç¤º
        function updateCurrentSubjectDisplay() {
            if (currentSubject) {
                currentSubjectDisplay.textContent = `å½“å‰ç§‘ç›®: ${currentSubject}`;
                currentSubjectDisplay.style.display = 'block';
            } else {
                currentSubjectDisplay.textContent = '';
                currentSubjectDisplay.style.display = 'none';
            }
        }

        // åŠ è½½æœ¬åœ°å­˜å‚¨çš„è®¾ç½®
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('slotSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    students = settings.students || [...DEFAULT_STUDENTS];
                    texts = settings.texts || [...DEFAULT_TEXTS];
                    punishments = settings.punishments || [...DEFAULT_PUNISHMENTS];
                    durations = settings.durations || [...DEFAULT_DURATIONS];
                    enableTrueRandom = settings.enableTrueRandom !== undefined ? settings.enableTrueRandom : true;
                    textsWeights = settings.textsWeights || {};
                    punishmentsWeights = settings.punishmentsWeights || {};
                    currentSubject = settings.currentSubject || null;
                }

                // åˆå§‹åŒ–æƒé‡ï¼ˆå¦‚æœæ²¡æœ‰è®¾ç½®ï¼‰
                initializeWeights();

                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const savedStats = localStorage.getItem('slotStatistics');
                if (savedStats) {
                    statistics = JSON.parse(savedStats);
                }
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
                students = [...DEFAULT_STUDENTS];
                texts = [...DEFAULT_TEXTS];
                punishments = [...DEFAULT_PUNISHMENTS];
                durations = [...DEFAULT_DURATIONS];
                enableTrueRandom = true;
                textsWeights = {};
                punishmentsWeights = {};
                initializeWeights();
            }

            // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å€¼
            updateSettingsUI();
            
            // åˆå§‹åŒ–æ§½ä½
            initSlots();

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStatistics();
        }

        // åˆå§‹åŒ–æƒé‡
        function initializeWeights() {
            // ä¸ºç¯‡ç›®è®¾ç½®é»˜è®¤æƒé‡
            texts.forEach(text => {
                if (textsWeights[text] === undefined) {
                    textsWeights[text] = 1;
                }
            });

            // ä¸ºæƒ©ç½šè®¾ç½®é»˜è®¤æƒé‡
            punishments.forEach(punishment => {
                if (punishmentsWeights[punishment] === undefined) {
                    punishmentsWeights[punishment] = 1;
                }
            });
        }

        // æ›´æ–°è®¾ç½®é¢æ¿UI
        function updateSettingsUI() {
            studentsInput.value = students.join(',');
            textsInput.value = texts.join(',');
            punishmentsInput.value = punishments.join(',');
            duration1.value = durations[0];
            duration2.value = durations[1];
            duration3.value = durations[2];
            enableTrueRandomCheckbox.checked = enableTrueRandom;

            // æ›´æ–°æƒé‡è¡¨æ ¼
            updateWeightTables();
        }

        // æ›´æ–°æƒé‡è¡¨æ ¼
        function updateWeightTables() {
            // æ›´æ–°ç¯‡ç›®æƒé‡è¡¨æ ¼
            const textsTable = document.getElementById('textsWeightTable').querySelector('tbody');
            textsTable.innerHTML = '';
            
            // è®¡ç®—æ€»æƒé‡
            const totalTextsWeight = texts.reduce((sum, text) => sum + (textsWeights[text] || 1), 0);
            
            // æ·»åŠ æ¯ä¸ªç¯‡ç›®çš„è¡Œ
            texts.forEach(text => {
                const weight = textsWeights[text] || 1;
                const probability = ((weight / totalTextsWeight) * 100).toFixed(1);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${text}</td>
                    <td><input type="number" class="weight-input" value="${weight}" min="0" step="0.1" data-item="${text}" data-type="text"></td>
                    <td>${probability}%</td>
                `;
                textsTable.appendChild(row);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            textsTable.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('change', updateItemWeight);
            });
            
            // æ›´æ–°æƒ©ç½šæƒé‡è¡¨æ ¼
            const punishmentsTable = document.getElementById('punishmentsWeightTable').querySelector('tbody');
            punishmentsTable.innerHTML = '';
            
            // è®¡ç®—æ€»æƒé‡
            const totalPunishmentsWeight = punishments.reduce((sum, punishment) => sum + (punishmentsWeights[punishment] || 1), 0);
            
            // æ·»åŠ æ¯ä¸ªæƒ©ç½šçš„è¡Œ
            punishments.forEach(punishment => {
                const weight = punishmentsWeights[punishment] || 1;
                const probability = ((weight / totalPunishmentsWeight) * 100).toFixed(1);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${punishment}</td>
                    <td><input type="number" class="weight-input" value="${weight}" min="0" step="0.1" data-item="${punishment}" data-type="punishment"></td>
                    <td>${probability}%</td>
                `;
                punishmentsTable.appendChild(row);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            punishmentsTable.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('change', updateItemWeight);
            });
        }

        // æ›´æ–°é¡¹ç›®æƒé‡
        function updateItemWeight(e) {
            const input = e.target;
            const item = input.dataset.item;
            const type = input.dataset.type;
            const weight = parseFloat(input.value) || 0;
            
            if (weight < 0) {
                input.value = 0;
                return;
            }
            
            // æ›´æ–°æƒé‡
            if (type === 'text') {
                textsWeights[item] = weight;
            } else if (type === 'punishment') {
                punishmentsWeights[item] = weight;
            }
            
            // é‡æ–°è®¡ç®—æ¦‚ç‡å¹¶æ›´æ–°æ˜¾ç¤º
            updateWeightTables();
        }

        // ä¿å­˜è®¾ç½®
        function saveSettingsToStorage() {
            try {
                // ä»è¾“å…¥æ¡†è·å–å€¼
                students = studentsInput.value.split(',').map(item => item.trim()).filter(item => item);
                texts = textsInput.value.split(',').map(item => item.trim()).filter(item => item);
                punishments = punishmentsInput.value.split(',').map(item => item.trim()).filter(item => item);
                durations = [
                    parseInt(duration1.value) || DEFAULT_DURATIONS[0],
                    parseInt(duration2.value) || DEFAULT_DURATIONS[1],
                    parseInt(duration3.value) || DEFAULT_DURATIONS[2]
                ];
                enableTrueRandom = enableTrueRandomCheckbox.checked;

                // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                if (students.length === 0) {
                    showTemporaryMessage('å­¦ç”Ÿåå•ä¸èƒ½ä¸ºç©ºï¼', true);
                    return false;
                }
                if (texts.length === 0) {
                    showTemporaryMessage('ç¯‡ç›®åˆ—è¡¨ä¸èƒ½ä¸ºç©ºï¼', true);
                    return false;
                }
                if (punishments.length === 0) {
                    showTemporaryMessage('æƒ©ç½šå†…å®¹ä¸èƒ½ä¸ºç©ºï¼', true);
                    return false;
                }

                // æ¸…ç†ä¸å†ä½¿ç”¨çš„æƒé‡
                const newTextsWeights = {};
                texts.forEach(text => {
                    newTextsWeights[text] = textsWeights[text] || 1;
                });
                textsWeights = newTextsWeights;

                const newPunishmentsWeights = {};
                punishments.forEach(punishment => {
                    newPunishmentsWeights[punishment] = punishmentsWeights[punishment] || 1;
                });
                punishmentsWeights = newPunishmentsWeights;

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const settings = {
                    students,
                    texts,
                    punishments,
                    durations,
                    enableTrueRandom,
                    textsWeights,
                    punishmentsWeights,
                    currentSubject
                };
                localStorage.setItem('slotSettings', JSON.stringify(settings));
                
                // æ›´æ–°æƒé‡è¡¨æ ¼
                updateWeightTables();
                
                // é‡æ–°åˆå§‹åŒ–æ§½ä½
                initSlots();
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                showTemporaryMessage('è®¾ç½®å·²ä¿å­˜');
                
                return true;
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                showTemporaryMessage('ä¿å­˜è®¾ç½®å¤±è´¥', true);
                return false;
            }
        }

        // é‡ç½®è®¾ç½®
        function resetSettingsToDefault() {
            students = [...DEFAULT_STUDENTS];
            texts = [...DEFAULT_TEXTS];
            punishments = [...DEFAULT_PUNISHMENTS];
            durations = [...DEFAULT_DURATIONS];
            enableTrueRandom = true;
            textsWeights = {};
            punishmentsWeights = {};
            
            // åˆå§‹åŒ–æƒé‡
            initializeWeights();
            
            updateSettingsUI();
            localStorage.removeItem('slotSettings');
            
            // é‡æ–°åˆå§‹åŒ–æ§½ä½
            initSlots();
        }

        // åˆå§‹åŒ–æ‰€æœ‰æ§½ä½
        function initSlots() {
            initSlot(slot1, students, 100);
            initSlot(slot2, texts, 50);
            initSlot(slot3, punishments, 50);
        }

        // æ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // åˆå§‹åŒ–å•ä¸ªæ§½ä½
        function initSlot(slot, data, repeatTimes) {
            const content = Array(repeatTimes).fill(data).flat();
            slot.innerHTML = content.map(item => 
                `<div class="slot-item">${item}</div>`
            ).join('');
            slot.style.transform = `translateY(${-(content.length * ITEM_HEIGHT / 2)}px)`;
        }

        // è·å–çœŸæ­£éšæœºçš„ç»“æœ
        function getTrueRandomResult(dataset, weights = null) {
            if (!weights) {
                // å¦‚æœæ²¡æœ‰æä¾›æƒé‡ï¼Œä½¿ç”¨å‡åŒ€åˆ†å¸ƒ
                return dataset[Math.floor(Math.random() * dataset.length)];
            }
            
            // è®¡ç®—æ€»æƒé‡
            let totalWeight = 0;
            const weightArray = dataset.map(item => {
                const weight = weights[item] || 1;
                totalWeight += weight;
                return weight;
            });
            
            // ç”Ÿæˆä¸€ä¸ª0åˆ°æ€»æƒé‡ä¹‹é—´çš„éšæœºæ•°
            const randomValue = Math.random() * totalWeight;
            
            // æ ¹æ®æƒé‡é€‰æ‹©é¡¹ç›®
            let cumulativeWeight = 0;
            for (let i = 0; i < dataset.length; i++) {
                cumulativeWeight += weightArray[i];
                if (randomValue < cumulativeWeight) {
                    return dataset[i];
                }
            }
            
            // é˜²æ­¢æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼Œè¿”å›æœ€åä¸€é¡¹
            return dataset[dataset.length - 1];
        }

        // åŠ¨ç”»æ•ˆæœ
        async function animateSlot(slot, dataset, duration, useTrueRandom = false, weights = null) {
            return new Promise(resolve => {
                // å¦‚æœä½¿ç”¨çœŸéšæœºï¼Œæå‰ç¡®å®šç»“æœ
                const trueRandomResult = useTrueRandom ? getTrueRandomResult(dataset, weights) : null;
                
                const startY = parseInt(slot.style.transform.match(/-?\d+/)[0]) || 0;
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç›®æ ‡ç´¢å¼•
                const targetIndex = Math.floor(Math.random() * dataset.length);
                // éšæœºåŒ–åç§»é‡ï¼Œå¢åŠ éšæœºæ€§
                const targetOffset = Math.floor(Math.random() * 3 + 1) * ITEM_HEIGHT;
                const targetY = -(targetIndex * ITEM_HEIGHT) + targetOffset;

                let startTime = null;
                let lastY = startY;
                let velocity = 0;
                const friction = 0.98; 

                function animate(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;

                    if (elapsed < duration * 0.8) {
                        // åŠ é€Ÿé˜¶æ®µï¼ŒéšæœºåŒ–åŠ é€Ÿåº¦å¢åŠ éšæœºæ€§
                        velocity = Math.min(velocity + (0.15 + Math.random() * 0.1), 30);
                    } 
                    else {
                        // å‡é€Ÿé˜¶æ®µ
                        velocity *= friction;
                        if (Math.abs(velocity) < 0.1) {
                            // å¦‚æœä½¿ç”¨çœŸéšæœºï¼Œç›´æ¥è¿”å›é¢„å…ˆç¡®å®šçš„ç»“æœ
                            if (useTrueRandom) {
                                // æ‰¾åˆ°ç»“æœåœ¨æ•°ç»„ä¸­çš„ä½ç½®
                                const resultIndex = dataset.indexOf(trueRandomResult);
                                // è®¡ç®—æœ€ç»ˆä½ç½®ï¼Œä½¿å…¶æ˜¾ç¤ºåœ¨ä¸­é—´
                                const finalY = -(resultIndex * ITEM_HEIGHT) + ITEM_HEIGHT;
                                slot.style.transform = `translateY(${finalY}px)`;
                                resolve(trueRandomResult);
                                return;
                            }
                            
                            // å¦åˆ™ä½¿ç”¨åŠ¨ç”»åœæ­¢ä½ç½®ç¡®å®šç»“æœ
                            const finalY = Math.round(lastY / ITEM_HEIGHT) * ITEM_HEIGHT;
                            slot.style.transform = `translateY(${finalY}px)`;
                            
                            // è®¡ç®—æœ€ç»ˆé€‰ä¸­çš„é¡¹ç›®
                            const index = Math.abs(Math.round(finalY / ITEM_HEIGHT)) % dataset.length;
                            resolve(dataset[index]);
                            return;
                        }
                    }

                    const newY = lastY - velocity;
                    slot.style.transform = `translateY(${newY}px)`;
                    lastY = newY;

                    // å¾ªç¯æ»šåŠ¨æ•ˆæœ
                    if (Math.abs(newY) > dataset.length * ITEM_HEIGHT) {
                        lastY = newY % (dataset.length * ITEM_HEIGHT);
                    }

                    requestAnimationFrame(animate);
                }

                requestAnimationFrame(animate);
            });
        }

        // å¼€å§‹æŠ½ç­¾
        async function startSpin() {
            if (isRunning) return;
            isRunning = true;
            spinBtn.style.display = 'none'; // éšè—æŒ‰é’®
            result.innerHTML = "ğŸ° æŠ½ç­¾è¿›è¡Œä¸­...";

            const shuffledStudents = shuffleArray(students);
            const shuffledTexts = shuffleArray(texts);
            const shuffledPunishments = shuffleArray(punishments);

            initSlot(slot1, shuffledStudents, 100);
            initSlot(slot2, shuffledTexts, 50);
            initSlot(slot3, shuffledPunishments, 50);

            try {
            const results = await Promise.all([
                    animateSlot(slot1, shuffledStudents, durations[0], enableTrueRandom),
                    animateSlot(slot2, shuffledTexts, durations[1], enableTrueRandom, textsWeights),
                    animateSlot(slot3, shuffledPunishments, durations[2], enableTrueRandom, punishmentsWeights)
            ]);

            result.innerHTML = `
                <div>ğŸ‰ æŠ½ä¸­ï¼š${results[0]}</div>
                <div>ğŸ“– ç¯‡ç›®ï¼š${results[1]}</div>
                <div>âš¡ æƒ©ç½šï¼š${results[2]}</div>
            `;

                // ä¿å­˜æŠ½ç­¾å†å²è®°å½•
                saveHistory(results);
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStatisticsData(results);
            } catch (error) {
                console.error('æŠ½ç­¾è¿‡ç¨‹å‡ºé”™:', error);
                result.innerHTML = "æŠ½ç­¾è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•";
            } finally {
                spinBtn.style.display = 'inline-block'; // é‡æ–°æ˜¾ç¤ºæŒ‰é’®
            isRunning = false;
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatisticsData(results) {
            // æ›´æ–°å­¦ç”Ÿç»Ÿè®¡
            if (!statistics.students[results[0]]) {
                statistics.students[results[0]] = 1;
            } else {
                statistics.students[results[0]]++;
            }
            
            // æ›´æ–°ç¯‡ç›®ç»Ÿè®¡
            if (!statistics.texts[results[1]]) {
                statistics.texts[results[1]] = 1;
            } else {
                statistics.texts[results[1]]++;
            }
            
            // æ›´æ–°æƒ©ç½šç»Ÿè®¡
            if (!statistics.punishments[results[2]]) {
                statistics.punishments[results[2]] = 1;
            } else {
                statistics.punishments[results[2]]++;
            }
            
            // ä¿å­˜ç»Ÿè®¡æ•°æ®
            localStorage.setItem('slotStatistics', JSON.stringify(statistics));
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStatistics();
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatistics() {
            statsContent.innerHTML = '';
            
            // åˆ›å»ºç»Ÿè®¡æ ‡é¢˜
            const createStatSection = (title, data, type) => {
                const section = document.createElement('div');
                section.style.width = '100%';
                section.style.marginBottom = '15px';
                
                const sectionTitle = document.createElement('h4');
                sectionTitle.textContent = title;
                sectionTitle.style.margin = '5px 0';
                sectionTitle.style.color = '#ddd';
                section.appendChild(sectionTitle);
                
                // è·å–æ€»æ¬¡æ•°
                let totalCount = 0;
                Object.values(data).forEach(count => {
                    totalCount += count;
                });
                
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                if (totalCount === 0) {
                    const noData = document.createElement('div');
                    noData.textContent = 'æš‚æ— æ•°æ®';
                    noData.style.color = '#888';
                    noData.style.fontSize = '14px';
                    section.appendChild(noData);
                    return section;
                }
                
                // åˆ›å»ºç»Ÿè®¡é¡¹
                const itemsContainer = document.createElement('div');
                itemsContainer.style.display = 'flex';
                itemsContainer.style.flexWrap = 'wrap';
                itemsContainer.style.gap = '8px';
                
                // è·å–å‰5ä¸ªæœ€å¸¸è§çš„é¡¹ç›®
                const sortedItems = Object.entries(data)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                sortedItems.forEach(([item, count]) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'stats-item';
                    const percentage = ((count / totalCount) * 100).toFixed(1);
                    itemElement.textContent = `${item}: ${count}æ¬¡ (${percentage}%)`;
                    itemsContainer.appendChild(itemElement);
                });
                
                section.appendChild(itemsContainer);
                
                // æ·»åŠ é‡ç½®æŒ‰é’®
                const resetButton = document.createElement('button');
                resetButton.textContent = 'é‡ç½®æ­¤ç»Ÿè®¡';
                resetButton.style.background = '#555';
                resetButton.style.border = 'none';
                resetButton.style.borderRadius = '5px';
                resetButton.style.color = 'white';
                resetButton.style.padding = '5px 10px';
                resetButton.style.marginTop = '10px';
                resetButton.style.cursor = 'pointer';
                resetButton.style.fontSize = '12px';
                
                resetButton.addEventListener('click', () => {
                    if (confirm(`ç¡®å®šè¦é‡ç½®${title}çš„ç»Ÿè®¡æ•°æ®å—ï¼Ÿ`)) {
                        statistics[type] = {};
                        localStorage.setItem('slotStatistics', JSON.stringify(statistics));
                        updateStatistics();
                    }
                });
                
                section.appendChild(resetButton);
                
                return section;
            };
            
            // æ·»åŠ å„éƒ¨åˆ†ç»Ÿè®¡
            statsContent.appendChild(createStatSection('å­¦ç”ŸæŠ½ä¸­ç»Ÿè®¡', statistics.students, 'students'));
            statsContent.appendChild(createStatSection('ç¯‡ç›®æŠ½ä¸­ç»Ÿè®¡', statistics.texts, 'texts'));
            statsContent.appendChild(createStatSection('æƒ©ç½šæŠ½ä¸­ç»Ÿè®¡', statistics.punishments, 'punishments'));
            
            // æ·»åŠ å…¨éƒ¨é‡ç½®æŒ‰é’®
            const resetAllButton = document.createElement('button');
            resetAllButton.textContent = 'é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®';
            resetAllButton.style.background = '#ff4757';
            resetAllButton.style.border = 'none';
            resetAllButton.style.borderRadius = '5px';
            resetAllButton.style.color = 'white';
            resetAllButton.style.padding = '8px 15px';
            resetAllButton.style.marginTop = '10px';
            resetAllButton.style.cursor = 'pointer';
            resetAllButton.style.width = '100%';
            
            resetAllButton.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ')) {
                    statistics = {
                        students: {},
                        texts: {},
                        punishments: {}
                    };
                    localStorage.setItem('slotStatistics', JSON.stringify(statistics));
                    updateStatistics();
                }
            });
            
            statsContent.appendChild(resetAllButton);
        }

        // ä¿å­˜æŠ½ç­¾å†å²
        function saveHistory(results) {
            try {
                const history = JSON.parse(localStorage.getItem('slotHistory') || '[]');
                history.push({
                    timestamp: new Date().toISOString(),
                    student: results[0],
                    text: results[1],
                    punishment: results[2]
                });
                
                // åªä¿ç•™æœ€è¿‘çš„50æ¡è®°å½•
                if (history.length > 50) {
                    history.shift();
                }
                
                localStorage.setItem('slotHistory', JSON.stringify(history));
            } catch (error) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        spinBtn.addEventListener('click', startSpin);
        
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });
        
        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        saveSettings.addEventListener('click', () => {
            if (saveSettingsToStorage()) {
                settingsModal.style.display = 'none';
            }
        });
        
        resetSettings.addEventListener('click', resetSettingsToDefault);
        
        toggleStats.addEventListener('click', () => {
            if (statsContainer.style.display === 'block') {
                statsContainer.style.display = 'none';
            } else {
                statsContainer.style.display = 'block';
                updateStatistics();
            }
        });
        
        // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // è·å–å½“å‰æ ‡ç­¾ç»„
                const tabGroup = this.parentElement;
                
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                tabGroup.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                this.classList.add('active');
                
                // è·å–ç›®æ ‡å†…å®¹ID
                const targetId = this.dataset.tab;
                
                // éšè—æ‰€æœ‰å†…å®¹
                const tabContents = tabGroup.parentElement.querySelectorAll('.tab-content');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                
                // æ˜¾ç¤ºç›®æ ‡å†…å®¹
                document.getElementById(targetId).classList.add('active');
            });
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        // æŒ‰ESCé”®å…³é—­è®¾ç½®é¢æ¿
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsModal.style.display === 'flex') {
                settingsModal.style.display = 'none';
            }
        });

        // ç§‘ç›®ç®¡ç†åŠŸèƒ½
        function loadSubjects() {
            try {
                const savedSubjects = localStorage.getItem('slotSubjects');
                if (savedSubjects) {
                    const subjects = JSON.parse(savedSubjects);
                    updateSubjectsList(subjects);
                } else {
                    updateSubjectsList({});
                }
            } catch (error) {
                console.error('åŠ è½½ç§‘ç›®å¤±è´¥:', error);
                updateSubjectsList({});
            }
        }

        function updateSubjectsList(subjects) {
            subjectsList.innerHTML = '';
            
            if (Object.keys(subjects).length === 0) {
                const noSubjects = document.createElement('div');
                noSubjects.textContent = 'æš‚æ— ä¿å­˜çš„ç§‘ç›®';
                noSubjects.style.color = '#888';
                subjectsList.appendChild(noSubjects);
                return;
            }
            
            for (const [name, config] of Object.entries(subjects)) {
                const subjectBtn = document.createElement('div');
                subjectBtn.className = 'subject-btn';
                if (currentSubject === name) {
                    subjectBtn.classList.add('active');
                }
                
                const btnContent = document.createElement('span');
                btnContent.textContent = name;
                subjectBtn.appendChild(btnContent);
                
                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-icon';
                deleteIcon.innerHTML = 'Ã—';
                deleteIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSubject(name);
                });
                subjectBtn.appendChild(deleteIcon);
                
                subjectBtn.addEventListener('click', () => {
                    loadSubjectConfig(name, config);
                });
                
                subjectsList.appendChild(subjectBtn);
            }
        }

        function saveCurrentAsSubject() {
            const name = subjectNameInput.value.trim();
            if (!name) {
                showTemporaryMessage('è¯·è¾“å…¥ç§‘ç›®åç§°', true);
                return;
            }
            
            try {
                const subjects = JSON.parse(localStorage.getItem('slotSubjects') || '{}');
                
                // ä¿å­˜å½“å‰é…ç½®
                subjects[name] = {
                    students: students,
                    texts: texts,
                    punishments: punishments,
                    durations: durations,
                    enableTrueRandom: enableTrueRandom,
                    textsWeights: textsWeights,
                    punishmentsWeights: punishmentsWeights
                };
                
                localStorage.setItem('slotSubjects', JSON.stringify(subjects));
                
                // æ›´æ–°å½“å‰ç§‘ç›®
                currentSubject = name;
                updateCurrentSubjectDisplay();
                saveSettingsToStorage();
                
                // æ›´æ–°ç§‘ç›®åˆ—è¡¨
                updateSubjectsList(subjects);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                subjectNameInput.value = '';
                
                // æ˜¾ç¤ºä¸´æ—¶æç¤ºä¿¡æ¯
                showTemporaryMessage(`ç§‘ç›® "${name}" ä¿å­˜æˆåŠŸï¼`);
            } catch (error) {
                console.error('ä¿å­˜ç§‘ç›®å¤±è´¥:', error);
                showTemporaryMessage('ä¿å­˜ç§‘ç›®å¤±è´¥', true);
            }
        }

        function loadSubjectConfig(name, config) {
            try {
                // åŠ è½½ç§‘ç›®é…ç½®
                students = [...config.students];
                texts = [...config.texts];
                punishments = [...config.punishments];
                durations = [...config.durations];
                enableTrueRandom = config.enableTrueRandom;
                textsWeights = {...config.textsWeights};
                punishmentsWeights = {...config.punishmentsWeights};
                
                // æ›´æ–°å½“å‰ç§‘ç›®
                currentSubject = name;
                updateCurrentSubjectDisplay();
                
                // æ›´æ–°UI
                updateSettingsUI();
                
                // ä¿å­˜è®¾ç½®
                saveSettingsToStorage();
                
                // æ›´æ–°ç§‘ç›®åˆ—è¡¨ï¼ˆæ›´æ–°æ´»åŠ¨çŠ¶æ€ï¼‰
                const subjects = JSON.parse(localStorage.getItem('slotSubjects') || '{}');
                updateSubjectsList(subjects);
                
                // é‡æ–°åˆå§‹åŒ–æ§½ä½
                initSlots();
                
                // æ˜¾ç¤ºä¸´æ—¶æç¤ºä¿¡æ¯
                showTemporaryMessage(`å·²åˆ‡æ¢åˆ°ç§‘ç›® "${name}"`);
            } catch (error) {
                console.error('åŠ è½½ç§‘ç›®é…ç½®å¤±è´¥:', error);
                showTemporaryMessage('åŠ è½½ç§‘ç›®é…ç½®å¤±è´¥', true);
            }
        }

        function deleteSubject(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç§‘ç›® "${name}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const subjects = JSON.parse(localStorage.getItem('slotSubjects') || '{}');
                
                // åˆ é™¤ç§‘ç›®
                delete subjects[name];
                
                localStorage.setItem('slotSubjects', JSON.stringify(subjects));
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç§‘ç›®ï¼Œæ¸…é™¤å½“å‰ç§‘ç›®
                if (currentSubject === name) {
                    currentSubject = null;
                    updateCurrentSubjectDisplay();
                    saveSettingsToStorage();
                }
                
                // æ›´æ–°ç§‘ç›®åˆ—è¡¨
                updateSubjectsList(subjects);
                
                // æ˜¾ç¤ºä¸´æ—¶æç¤ºä¿¡æ¯
                showTemporaryMessage(`ç§‘ç›® "${name}" å·²åˆ é™¤`);
            } catch (error) {
                console.error('åˆ é™¤ç§‘ç›®å¤±è´¥:', error);
                showTemporaryMessage('åˆ é™¤ç§‘ç›®å¤±è´¥', true);
            }
        }

        // æ˜¾ç¤ºä¸´æ—¶æç¤ºä¿¡æ¯
        function showTemporaryMessage(message, isError = false) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.position = 'fixed';
            messageElement.style.bottom = '20px';
            messageElement.style.left = '50%';
            messageElement.style.transform = 'translateX(-50%)';
            messageElement.style.padding = '10px 20px';
            messageElement.style.borderRadius = '5px';
            messageElement.style.color = 'white';
            messageElement.style.fontSize = '16px';
            messageElement.style.zIndex = '2000';
            messageElement.style.opacity = '0';
            messageElement.style.transition = 'opacity 0.3s';
            
            // æ ¹æ®æ˜¯å¦ä¸ºé”™è¯¯è®¾ç½®ä¸åŒçš„èƒŒæ™¯è‰²
            if (isError) {
                messageElement.style.background = 'rgba(255, 71, 87, 0.9)';
            } else {
                messageElement.style.background = 'rgba(46, 204, 113, 0.9)';
            }
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(messageElement);
            
            // æ˜¾ç¤ºæç¤º
            setTimeout(() => {
                messageElement.style.opacity = '1';
            }, 10);
            
            // 3ç§’åéšè—å¹¶ç§»é™¤
            setTimeout(() => {
                messageElement.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageElement);
                }, 300);
            }, 3000);
        }

        // ç§‘ç›®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
        saveSubjectBtn.addEventListener('click', saveCurrentAsSubject);

        // åˆå§‹åŒ–
        loadSettings();
        loadSubjects();
        updateCurrentSubjectDisplay();
    </script>
</body>
</html>